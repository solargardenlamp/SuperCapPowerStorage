<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Real-Time Data Monitor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Custom font and base styling */
        body { font-family: 'Inter', sans-serif; }
        /* Smooth transition for data updates */
        .data-value { transition: color 0.3s, background-color 0.3s; }
        /* Add a slight pulse animation on update */
        @keyframes pulse-highlight {
            0% { background-color: rgba(255, 255, 255, 0.1); }
            50% { background-color: rgba(255, 255, 255, 0.2); }
            100% { background-color: rgba(255, 255, 255, 0.1); }
        }
        .highlight {
            animation: pulse-highlight 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-400 tracking-tight">Solar Garden Lamp Monitor</h1>
            <p class="mt-2 text-lg text-gray-400">Real-Time Data from ESP32 via Firebase</p>
        </header>

        <!-- Status and Last Updated Time -->
        <div id="status" class="text-center mb-6 p-4 rounded-lg bg-gray-800 shadow-xl">
            <p class="text-sm font-medium text-gray-400">
                Connection Status: <span id="connection-status" class="text-green-400 font-bold">Connecting...</span>
            </p>
            <p class="text-sm text-gray-500 mt-1">
                Last Updated: <span id="last-updated">N/A</span>
            </p>
        </div>

        <!-- Data Grid -->
        <div id="data-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Data Cards will be injected here -->
            <div id="loading-spinner" class="md:col-span-2 text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3 text-gray-400">Loading initial data...</p>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace the values below with your actual credentials.
        const firebaseConfig = {
            apiKey: "AIzaSyCMR8Dl1_z8Ny2afjjbXWdd48TSvYgHgfo",
            databaseURL: "https://solargardenlampmonitor-default-rtdb.asia-southeast1.firebasedatabase.app/",
        };

        // Path to the data node in your Firebase Realtime Database
        const DATA_PATH = '';

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.database();
        const dataRef = db.ref(DATA_PATH);

        // DOM Elements
        const dataGrid = document.getElementById('data-grid');
        const connectionStatus = document.getElementById('connection-status');
        const lastUpdated = document.getElementById('last-updated');

        /**
         * Converts a field name (e.g., "Capacitor Voltage") into a card title, 
         * and assigns units and icons.
         * @param {string} key The raw data key.
         * @returns {{title: string, unit: string, icon: string}}
         */
        function getFieldInfo(key) {
            let title = key.replace(/([A-Z])/g, ' $1').trim(); // Add space before capital letters
            let unit = '';
            let icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`; // Default Bolt icon

            if (key.toLowerCase().includes('voltage')) {
                unit = 'V';
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l2.365 3.155a1 1 0 001.27 0L15 6v13"></path></svg>`; // Lightning
            } else if (key.toLowerCase().includes('current')) {
                unit = 'A';
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.333-3.333 4-5 8-5 1 0 2 1 2 2 0 4-3 6-8 8s-8 4-8 8c0 1 1 2 2 2 4 0 6.667-1.667 8-5"></path></svg>`; // Circuit
            } else if (key.toLowerCase().includes('panel')) {
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`; // Sun
            } else if (key.toLowerCase().includes('mppt')) {
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>`; // Chip
            } else if (key.toLowerCase().includes('capacitor')) {
                icon = `<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9h-3a4 4 0 01-4-4V7a4 4 0 00-4-4H3"></path></svg>`; // Battery/Storage
            }
            
            return { title, unit, icon };
        }

        /**
         * Renders the data grid based on the snapshot.
         * @param {object} data The sensor data object.
         */
        function renderData(data) {
            dataGrid.innerHTML = ''; // Clear previous content

            if (!data || Object.keys(data).length === 0) {
                dataGrid.innerHTML = `<p class="md:col-span-2 text-center text-gray-500 py-10">No data found at '${DATA_PATH}'. Check ESP32 connection and Firebase path.</p>`;
                return;
            }

            Object.entries(data).forEach(([key, value]) => {
                const id = key.replace(/\s+/g, '-').toLowerCase(); // Create a safe ID
                const { title, unit, icon } = getFieldInfo(key);

                // Create or find existing card element
                let card = document.getElementById(id);
                if (!card) {
                    card = document.createElement('div');
                    card.id = id;
                    card.className = 'data-card bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 hover:border-indigo-500 transition duration-300';
                    card.innerHTML = `
                        <div class="flex items-center mb-3 text-indigo-400">
                            ${icon}
                            <h2 class="text-xl font-semibold">${title}</h2>
                        </div>
                        <p class="text-gray-300 text-sm mb-2">Current Reading</p>
                        <div class="flex items-baseline">
                            <span class="data-value text-6xl font-extrabold text-white" data-unit="${unit}">${value !== null ? value : 'N/A'}</span>
                            <span class="text-3xl font-light text-indigo-300 ml-2">${unit}</span>
                        </div>
                    `;
                    dataGrid.appendChild(card);
                } else {
                    // Update existing card data
                    const valueSpan = card.querySelector('.data-value');
                    const oldValue = valueSpan.textContent;
                    const newValue = value !== null ? value : 'N/A';

                    if (oldValue !== newValue) {
                        valueSpan.textContent = newValue;
                        // Highlight on change
                        card.classList.add('highlight');
                        setTimeout(() => card.classList.remove('highlight'), 500);
                    }
                }
            });

            // Update timestamp
            const now = new Date();
            lastUpdated.textContent = now.toLocaleTimeString() + ' on ' + now.toLocaleDateString();
        }

        // --- Real-time Data Listener ---

        // Listen for connection status
        db.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                connectionStatus.textContent = "Connected";
                connectionStatus.classList.remove('text-yellow-500', 'text-red-500');
                connectionStatus.classList.add('text-green-400');
            } else {
                connectionStatus.textContent = "Disconnected";
                connectionStatus.classList.remove('text-green-400');
                connectionStatus.classList.add('text-red-500');
            }
        });

        // Listen for data changes at the 'data_from_esp32' path
        dataRef.on('value', (snapshot) => {
            document.getElementById('loading-spinner')?.remove(); // Hide spinner once data arrives
            connectionStatus.textContent = "Streaming Live";
            connectionStatus.classList.remove('text-yellow-500', 'text-red-500');
            connectionStatus.classList.add('text-green-400');

            const data = snapshot.val();
            if (data) {
                renderData(data);
            } else {
                console.warn(`Data snapshot at '${DATA_PATH}' is null.`);
                dataGrid.innerHTML = `<p class="md:col-span-2 text-center text-gray-500 py-10">No data found at '${DATA_PATH}'. Check ESP32 connection and Firebase path.</p>`;
            }
        }, (error) => {
            console.error("Firebase Read Failed:", error);
            connectionStatus.textContent = "Error";
            connectionStatus.classList.remove('text-green-400');
            connectionStatus.classList.add('text-red-500');
            dataGrid.innerHTML = `<p class="md:col-span-2 text-center text-red-500 py-10">ERROR: Could not fetch data. Check API Key and Database URL.</p>`;
        });

    </script>

</body>
</html>
